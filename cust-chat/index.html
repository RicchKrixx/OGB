<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OGB â€¢ Customer Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <style>
    body{font-family:sans-serif;background:#111;color:#fff;display:flex;flex-direction:column;height:100vh;margin:0;}
    header{padding:1rem;background:#b8860b;text-align:center;font-weight:bold;}
    #chat-box{flex:1;overflow-y:auto;padding:1rem;}
    .msg{margin:0.5rem 0;padding:0.8rem;border-radius:12px;max-width:70%;}
    .customer{background:#444;margin-left:auto;}
    .admin{background:#b8860b;color:#111;margin-right:auto;}
    footer{display:flex;gap:0.5rem;padding:0.5rem;background:#222;}
    input{flex:1;padding:0.7rem;border:none;border-radius:8px;}
    button{background:#b8860b;border:none;padding:0.7rem 1rem;border-radius:8px;cursor:pointer;}
    #status{padding:0.3rem;text-align:center;background:#333;}
  </style>
</head>
<body>
  <header>Customer Chat</header>
  <div id="status">Status: <span id="chatStatus">Loading...</span></div>
  <div id="chat-box"></div>
  <footer>
    <input type="text" id="messageInput" placeholder="Type your message..."/>
    <button id="sendBtn"><i class="fa fa-paper-plane"></i></button>
    <button id="endBtn">End Chat</button>
  </footer>

<script>
  // Your Firebase Config
  const firebaseConfig = {
    apiKey: "...",
    authDomain: "...",
    projectId: "...",
  };
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.getAuth(app);
  const db = firebase.getFirestore(app);

  const chatBox = document.getElementById("chat-box");
  const msgInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const endBtn = document.getElementById("endBtn");
  const chatStatus = document.getElementById("chatStatus");

  firebase.onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = "login.html"; // redirect if not logged in
      return;
    }
    const chatRef = firebase.doc(db, "chats", user.uid);
    const messagesRef = firebase.collection(chatRef, "messages");

    // Listen for messages
    firebase.onSnapshot(messagesRef, snap => {
      chatBox.innerHTML = "";
      snap.forEach(doc => {
        const msg = doc.data();
        const div = document.createElement("div");
        div.className = "msg " + msg.sender;
        div.innerText = msg.text;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Listen for chat status
    firebase.onSnapshot(chatRef, doc => {
      if (doc.exists()) {
        chatStatus.textContent = doc.data().status;
      }
    });

    // Send message
    sendBtn.onclick = async () => {
      if (msgInput.value.trim() === "") return;
      await firebase.addDoc(messagesRef, {
        sender: "customer",
        text: msgInput.value,
        timestamp: firebase.serverTimestamp()
      });
      await firebase.setDoc(chatRef, { email: user.email, status: "active" }, { merge: true });
      msgInput.value = "";
    };

    // End chat
    endBtn.onclick = async () => {
      await firebase.setDoc(chatRef, { status: "ended" }, { merge: true });
    };
  });
</script>
</body>
</html>