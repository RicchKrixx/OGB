<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Orders â€¢ On God Bend Mini Mart</title>
<style>
:root {
  --brand: #b8860b; 
  --brand-dark: #8b6508;
  --ink: #1f1f1f;
  --bg: #f7f7f9;
  --card: #ffffff;
}
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);}
a{color:inherit;text-decoration:none;}
/* Header */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;background:#111;color:#fff;
}
.brand{display:flex;align-items:center;gap:10px;}
.brand img{height:90px;width:auto;border-radius:6px;}
.nav{display:flex;gap:14px;}
.nav a{padding:8px 10px;border-radius:8px;}
.nav a:hover{background:rgba(255,255,255,.08);}
.cart-btn{display:inline-flex;align-items:center;gap:8px;background:var(--brand);color:#fff;border:0;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer;}
.badge{background:#111;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px;}
/* Orders */
.main{padding:20px; max-width:1000px;margin:0 auto;}
h1{margin-bottom:20px;color:#111;}
.order{background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:16px;}
.order h2{margin:0 0 10px;font-size:18px;color:#333;}
.items p{margin:4px 0; display: flex; align-items: center; gap: 8px;}
.total{font-weight:bold;margin-top:8px;}
.status{font-weight:bold;margin-top:4px;}
/* Footer */
footer{padding:24px 16px;text-align:center;background:#111;color:#bbb;margin-top:26px;}

/* Product images */
.items img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.2s;
}
.items img:hover {
  transform: scale(1.1);
}

/* Buttons */
.buttons {
  margin-top: 8px;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.buttons button {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  color: #fff;
}
.statusBtn { font-weight: bold; }
.cancel { background: #d9534f; }

/* Status colors */
.Preparing { background: #f0ad4e; }
["On the way"] { background: #5bc0de; }
.Delivered { background: #5cb85c; }
.Complete { background: #777; cursor: not-allowed; }

/* Lightbox modal */
#imgModal {
  display: none; position: fixed; z-index: 1000;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.8);
  justify-content: center; align-items: center;
}
#imgModal img {
  max-width: 90%; max-height: 90%; border-radius: 10px;
}
#imgModal span {
  position: absolute; top: 20px; right: 30px;
  color: #fff; font-size: 30px; cursor: pointer;
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="brand">
    <img src="https://i.postimg.cc/bJRyWDhS/file-000000003574620aa7b29924f4c1965a.png" alt="Logo"/>
  </div>
  <nav class="nav">OGB ORDERSðŸ“¥</nav>
</header>

<!-- ORDERS -->
<div class="main">
  <h1>Received Orders</h1>
  <div id="ordersContainer"></div>
</div>

<!-- Modal for image preview -->
<div id="imgModal"><span onclick="document.getElementById('imgModal').style.display='none'">&times;</span><img id="modalImg"/></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAwzdua-29Bp19C5_OfXX4PWuCGHsOKfag",
  authDomain: "ongod-5073e.firebaseapp.com",
  projectId: "ongod-5073e",
  storageBucket: "ongod-5073e.firebasestorage.app",
  messagingSenderId: "439687837026",
  appId: "1:439687837026:web:1f752fc79a41e9f5bd283b",
  measurementId: "G-1TVP0X3J62"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
document.getElementById("year").textContent = new Date().getFullYear();

const container = document.getElementById("ordersContainer");
const statusFlow = ["Pending","Preparing","Ontheway","Delivered","Complete"];

// Show image in modal
function showImage(src){
  document.getElementById("modalImg").src = src;
  document.getElementById("imgModal").style.display = "flex";
}

// Advance status button
function advanceStatus(orderId,newStatus){
  const docRef = db.collection("orders").doc(orderId);
  docRef.update({ status: newStatus }).then(()=>{
    console.log(`Order ${orderId} updated to ${newStatus}`);
  }).catch(err=>console.error(err));
}

// Cancel order
function cancelOrder(orderId){
  if(confirm("Are you sure you want to cancel this order?")){
    const docRef = db.collection("orders").doc(orderId);
    docRef.update({ status: "Cancelled" }).then(()=>{
      console.log(`Order ${orderId} cancelled`);
    }).catch(err=>console.error(err));
  }
}

// Render orders
function renderOrder(doc){
  const o = doc.data();
  const div = document.createElement("div");
  div.className = "order";

  const itemsHTML = o.items.map(i=>{
    const img = i.image ? `<img src="${i.image}" alt="${i.name}" onclick="showImage('${i.image}')"/>` : "";
    const qty = i.qty||i.quantity||1;
    return `<p>${img} ${i.name} x${qty} â€” GHS ${i.price*qty}</p>`;
  }).join("");

  const latlng = (o.latitude && o.longitude) ? ` (${o.latitude.toFixed(6)}, ${o.longitude.toFixed(6)})` : "";

  let nextStatus = "Preparing";
  const currentIndex = statusFlow.indexOf(o.status);
  if(currentIndex >= 0 && currentIndex < statusFlow.length-1){
    nextStatus = statusFlow[currentIndex+1];
  } else if(o.status === "Complete" || o.status === "Cancelled"){
    nextStatus = null;
  }

  const statusBtnHTML = nextStatus ? `<button class="statusBtn ${nextStatus.replace(/\s/g,'')}" onclick="advanceStatus('${doc.id}','${nextStatus}')">${nextStatus}</button>` : `<span style="color:grey;font-weight:bold;">${o.status}</span>`;
  const cancelBtnHTML = (o.status !== "Complete" && o.status !== "Cancelled") ? `<button class="cancel" onclick="cancelOrder('${doc.id}')">Cancel Order</button>` : "";

  div.innerHTML = `
    <h2>Order ID: ${doc.id}</h2>
    <p><b>Name:</b> ${o.name}</p>
    <p><b>Phone:</b> ${o.phone}</p>
    <p><b>Email:</b> ${o.email || "N/A"}</p>
    <p><b>Address:</b> ${o.address}${latlng}</p>
    <p><b>Date:</b> ${o.createdAt?.toDate ? o.createdAt.toDate().toLocaleString() : o.createdAt}</p>
    <div class="items"><b>Items:</b>${itemsHTML}</div>
    <p class="total">Total: GHS ${o.total}</p>
    <p class="status"><b>Payment:</b> ${o.payMethod} | <b>Status:</b> ${o.status}</p>
    <div class="buttons">
      ${statusBtnHTML}
      ${cancelBtnHTML}
    </div>
  `;
  container.prepend(div);
}


// Real-time listener
db.collection("orders")
  .orderBy("createdAt","desc")
  .onSnapshot(snapshot=>{
    container.innerHTML="";
    if(snapshot.empty){
      container.innerHTML="<p>No orders yet.</p>";
      return;
    }
    snapshot.forEach(doc=>renderOrder(doc));
  },err=>{
    console.error(err);
    container.innerHTML="<p>Failed to load orders.</p>";
  });
</script>
<script>
// Prevent screen from sleeping
let wakeLock = null;

async function requestWakeLock() {
  try {
    wakeLock = await navigator.wakeLock.request("screen");
    console.log("Wake lock active");

    // If the lock is released (e.g., tab switch), request it again
    wakeLock.addEventListener("release", () => {
      console.log("Wake lock released, re-requesting...");
      requestWakeLock();
    });
  } catch (err) {
    console.error(`${err.name}, ${err.message}`);
  }
}

// Try to activate wake lock when page is visible
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    requestWakeLock();
  } else if (wakeLock !== null) {
    wakeLock.release();
    wakeLock = null;
  }
});

// Request wake lock on page load
requestWakeLock();
</script>
</body>
</html>